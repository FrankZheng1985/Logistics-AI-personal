# 🔐 腾讯云服务器安全加固执行指南

## 📋 当前状态

**服务器IP**: 81.70.239.82  
**你的公网IP**: 210.149.115.5  
**检查时间**: 2026-01-19

### 🔴 发现的安全问题

1. ❌ **PostgreSQL端口 (5432) 未受保护** - 高风险
2. ❌ **MySQL端口 (33066) 未受保护** - 高风险  
3. ❌ **Redis端口 (6379) 未受保护** - 高风险
4. ⚠️ **SSH端口 (22) 对所有IP开放** - 中风险

---

## 🎯 安全加固目标

执行安全加固后，将实现：

### ✅ SSH访问控制
- 仅允许你的IP (210.149.115.5) 访问SSH
- 允许GitHub Actions IP段（用于自动部署）
- 其他IP将被拒绝

### ✅ 数据库端口保护
- PostgreSQL (5432) - 仅本地访问
- MySQL (33066) - 仅本地访问
- Redis (6379) - 仅本地访问

### ✅ 内部服务保护
- 前端服务 (3000, 3001) - 仅本地访问
- 后端API (8000) - 仅本地访问

### ✅ Web服务开放
- HTTP (80) - 公开访问 ✅
- HTTPS (443) - 公开访问 ✅
- Nginx管理 (9000) - 公开访问 ✅

### ✅ 防暴力破解
- SSH连接限制：每分钟最多3次尝试
- Fail2Ban自动封禁恶意IP
- ICMP限速，防止Ping洪水攻击

---

## 🚀 快速执行（推荐）

如果你确认要执行安全加固，请按以下步骤操作：

### 方法A: 一键执行（最简单）

```bash
# 1. SSH连接到服务器
ssh -i /Users/fengzheng/Downloads/Cursor.pem ubuntu@81.70.239.82

# 2. 进入脚本目录
cd /home/ubuntu/logistics-ai/scripts

# 3. 添加执行权限
chmod +x security-hardening.sh manage-whitelist.sh security-check.sh

# 4. 执行安全加固（约2-3分钟）
sudo ./security-hardening.sh

# 5. 验证配置
sudo ./security-check.sh
```

### 方法B: 通过本地命令执行

```bash
# 在本地终端执行
ssh -i /Users/fengzheng/Downloads/Cursor.pem ubuntu@81.70.239.82 "cd /home/ubuntu/logistics-ai/scripts && chmod +x security-hardening.sh && sudo ./security-hardening.sh"
```

---

## ⚠️ 执行前必读

### 🔴 重要警告

1. **备份优先**: 建议先在腾讯云控制台创建服务器快照
2. **保持连接**: 执行过程中不要关闭SSH会话
3. **测试连接**: 完成后先测试新SSH连接，确认可以访问
4. **IP变更**: 如果你的IP变更，需要使用腾讯云VNC登录添加新IP

### ✅ 安全保障

- 脚本会自动备份当前防火墙规则到 `/tmp/iptables-backup-*.txt`
- 脚本会备份SSH配置到 `/etc/ssh/sshd_config.backup-*`
- 允许已建立的连接继续（不会断开当前SSH）
- 配置会永久保存，重启后依然有效

---

## 📝 执行步骤详解

### 步骤1: 连接服务器

```bash
ssh -i /Users/fengzheng/Downloads/Cursor.pem ubuntu@81.70.239.82
```

### 步骤2: 检查脚本是否上传成功

```bash
ls -lh /home/ubuntu/logistics-ai/scripts/security-*.sh
```

应该看到：
- `security-hardening.sh` - 安全加固脚本
- `security-check.sh` - 安全检查脚本
- `manage-whitelist.sh` - 白名单管理脚本

### 步骤3: 添加执行权限

```bash
cd /home/ubuntu/logistics-ai/scripts
chmod +x security-hardening.sh manage-whitelist.sh security-check.sh
```

### 步骤4: 执行安全加固

```bash
sudo ./security-hardening.sh
```

**执行时间**: 约2-3分钟

**执行过程**:
1. ✅ 备份当前防火墙规则
2. ✅ 配置SSH访问白名单
3. ✅ 保护数据库端口
4. ✅ 配置Web服务访问
5. ✅ 配置防暴力破解规则
6. ✅ 配置ICMP限制
7. ✅ 保存防火墙规则
8. ✅ 配置SSH安全加固
9. ✅ 配置Fail2Ban
10. ✅ 显示当前防火墙规则

### 步骤5: 验证配置

```bash
sudo ./security-check.sh
```

应该看到：
- ✅ PostgreSQL端口保护 - 通过
- ✅ MySQL端口保护 - 通过
- ✅ Redis端口保护 - 通过
- ✅ SSH端口保护 - 通过

### 步骤6: 测试SSH连接

**重要**: 不要关闭当前SSH会话，打开新的终端窗口测试：

```bash
# 在新的终端窗口执行
ssh -i /Users/fengzheng/Downloads/Cursor.pem ubuntu@81.70.239.82
```

如果连接成功，说明白名单配置正确！

### 步骤7: 更新系统（可选）

```bash
sudo apt update && sudo apt upgrade -y
```

---

## 🛠️ 日常管理

### 添加新的白名单IP

如果你换了网络环境，IP变更了：

```bash
# 方法1: 自动获取当前IP并添加
sudo ./manage-whitelist.sh current

# 方法2: 手动指定IP
sudo ./manage-whitelist.sh add 新的IP地址
```

### 查看当前白名单

```bash
sudo ./manage-whitelist.sh list
```

### 删除白名单IP

```bash
sudo ./manage-whitelist.sh remove IP地址
```

### 定期安全检查

建议每周运行一次：

```bash
sudo ./security-check.sh
```

---

## 🆘 紧急情况处理

### 情况1: 被锁在服务器外

如果你的IP变更了，无法SSH连接：

**解决方案A: 使用腾讯云VNC**
1. 登录腾讯云控制台
2. 找到云服务器 81.70.239.82
3. 点击"登录" → "VNC登录"
4. 使用ubuntu用户登录
5. 运行: `sudo ./manage-whitelist.sh current`

**解决方案B: 临时开放SSH（不推荐）**
1. 通过腾讯云VNC登录
2. 运行: `sudo iptables -I INPUT -p tcp --dport 22 -j ACCEPT`
3. 从新IP连接后，添加新IP到白名单
4. 运行: `sudo ./manage-whitelist.sh apply`

### 情况2: 配置出错需要回滚

```bash
# 恢复备份的防火墙规则
sudo iptables-restore < /tmp/iptables-backup-YYYYMMDD-HHMMSS.txt

# 恢复SSH配置
sudo cp /etc/ssh/sshd_config.backup-* /etc/ssh/sshd_config
sudo systemctl restart sshd
```

### 情况3: 需要临时关闭防火墙

```bash
# 清空所有规则（仅临时，重启后恢复）
sudo iptables -F

# 重新应用安全规则
sudo ./manage-whitelist.sh apply
```

---

## 📊 预期结果

执行完成后，运行 `sudo ./security-check.sh` 应该看到：

```
==========================================
检查摘要
==========================================
总检查项: 16
通过: 15 ✅
警告: 1 ⚠️
失败: 0 ❌

安全检查全部通过！
```

---

## 📞 需要帮助？

如果执行过程中遇到问题：

1. **不要关闭当前SSH会话**
2. **截图错误信息**
3. **查看日志**: `sudo tail -f /var/log/auth.log`
4. **使用腾讯云VNC登录**作为备用方案

---

## ✅ 执行检查清单

在执行前，请确认：

- [ ] 已阅读并理解本文档
- [ ] 已知晓你的当前公网IP: 210.149.115.5
- [ ] 已准备好SSH密钥: /Users/fengzheng/Downloads/Cursor.pem
- [ ] 已在腾讯云控制台创建服务器快照（强烈建议）
- [ ] 已准备好腾讯云VNC登录作为备用方案
- [ ] 理解执行后SSH仅允许白名单IP访问

---

## 🚀 准备好了吗？

如果你已经准备好执行安全加固，请运行：

```bash
ssh -i /Users/fengzheng/Downloads/Cursor.pem ubuntu@81.70.239.82 "cd /home/ubuntu/logistics-ai/scripts && chmod +x security-hardening.sh && sudo ./security-hardening.sh"
```

或者手动执行上面的步骤1-7。

---

**文档更新时间**: 2026-01-19  
**预计执行时间**: 5-10分钟  
**风险等级**: 🟡 中等（已有备份机制）
