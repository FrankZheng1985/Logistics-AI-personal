# è…¾è®¯äº‘æœåŠ¡å™¨å®‰å…¨ç®¡ç†æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬ç›®å½•åŒ…å«äº†ç”¨äºåŠ å›ºå’Œç®¡ç†è…¾è®¯äº‘æœåŠ¡å™¨å®‰å…¨çš„è„šæœ¬å·¥å…·ã€‚è¿™äº›è„šæœ¬å¯ä»¥å¸®åŠ©ä½ ï¼š

- ğŸ”’ è®¾ç½®IPç™½åå•ï¼Œé™åˆ¶SSHè®¿é—®
- ğŸ›¡ï¸ ä¿æŠ¤æ•°æ®åº“å’Œå†…éƒ¨æœåŠ¡ç«¯å£
- ğŸš« é˜²æ­¢æš´åŠ›ç ´è§£æ”»å‡»
- ğŸ“Š å®šæœŸæ£€æŸ¥æœåŠ¡å™¨å®‰å…¨çŠ¶æ€

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ä¸Šä¼ è„šæœ¬åˆ°æœåŠ¡å™¨

```bash
# ä»æœ¬åœ°ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp -i /Users/fengzheng/Downloads/Cursor.pem \
  scripts/security-hardening.sh \
  scripts/manage-whitelist.sh \
  scripts/security-check.sh \
  ubuntu@81.70.239.82:/home/ubuntu/logistics-ai/scripts/
```

### 2. é¦–æ¬¡å®‰å…¨åŠ å›º

```bash
# SSHè¿æ¥åˆ°æœåŠ¡å™¨
ssh -i /Users/fengzheng/Downloads/Cursor.pem ubuntu@81.70.239.82

# è¿›å…¥è„šæœ¬ç›®å½•
cd /home/ubuntu/logistics-ai/scripts

# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x security-hardening.sh manage-whitelist.sh security-check.sh

# è¿è¡Œå®‰å…¨åŠ å›ºè„šæœ¬ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰
sudo ./security-hardening.sh
```

âš ï¸ **é‡è¦æç¤º**ï¼š
- é¦–æ¬¡è¿è¡Œä¼šé…ç½®é˜²ç«å¢™è§„åˆ™ï¼Œå¯èƒ½ä¼šå½±å“SSHè¿æ¥
- è¯·ç¡®ä¿ä½ çš„IP (210.149.115.5) åœ¨ç™½åå•ä¸­
- è¿è¡Œå‰å»ºè®®å…ˆå¤‡ä»½æœåŠ¡å™¨å¿«ç…§

## ğŸ“š è„šæœ¬è¯´æ˜

### 1. security-hardening.sh - å®‰å…¨åŠ å›ºè„šæœ¬

**åŠŸèƒ½**ï¼š
- âœ… é…ç½®SSHç™½åå•ï¼ˆä»…å…è®¸ç‰¹å®šIPè®¿é—®ï¼‰
- âœ… ä¿æŠ¤æ•°æ®åº“ç«¯å£ï¼ˆPostgreSQLã€MySQLã€Redisï¼‰
- âœ… ä¿æŠ¤å†…éƒ¨æœåŠ¡ç«¯å£ï¼ˆ3000ã€3001ã€8000ï¼‰
- âœ… é…ç½®SSHé˜²æš´åŠ›ç ´è§£
- âœ… ç¦ç”¨SSHå¯†ç ç™»å½•
- âœ… å®‰è£…å¹¶é…ç½®Fail2Ban
- âœ… æ°¸ä¹…ä¿å­˜é˜²ç«å¢™è§„åˆ™

**ä½¿ç”¨æ–¹æ³•**ï¼š
```bash
sudo ./security-hardening.sh
```

**é…ç½®çš„ç™½åå•IP**ï¼š
- `210.149.115.5` - ä½ çš„å½“å‰IP
- `127.0.0.1` - æœ¬åœ°å›ç¯
- GitHub Actions IPæ®µï¼ˆç”¨äºè‡ªåŠ¨éƒ¨ç½²ï¼‰

### 2. manage-whitelist.sh - IPç™½åå•ç®¡ç†å·¥å…·

**åŠŸèƒ½**ï¼š
- ğŸ“‹ æŸ¥çœ‹å½“å‰ç™½åå•
- â• æ·»åŠ æ–°IPåˆ°ç™½åå•
- â– ä»ç™½åå•åˆ é™¤IP
- ğŸŒ è·å–å½“å‰å…¬ç½‘IPå¹¶æ·»åŠ 
- ğŸ”„ åº”ç”¨ç™½åå•é…ç½®

**ä½¿ç”¨æ–¹æ³•**ï¼š

```bash
# æŸ¥çœ‹å½“å‰ç™½åå•
sudo ./manage-whitelist.sh list

# æ·»åŠ æ–°IP
sudo ./manage-whitelist.sh add 192.168.1.100

# åˆ é™¤IP
sudo ./manage-whitelist.sh remove 192.168.1.100

# è·å–å¹¶æ·»åŠ å½“å‰å…¬ç½‘IP
sudo ./manage-whitelist.sh current

# åº”ç”¨ç™½åå•é…ç½®
sudo ./manage-whitelist.sh apply

# æ˜¾ç¤ºå¸®åŠ©
./manage-whitelist.sh help
```

**ç¤ºä¾‹åœºæ™¯**ï¼š

1. **åœ¨æ–°åœ°ç‚¹å·¥ä½œï¼Œéœ€è¦æ·»åŠ æ–°IP**ï¼š
```bash
# æ–¹æ³•1ï¼šè‡ªåŠ¨è·å–å½“å‰IP
sudo ./manage-whitelist.sh current

# æ–¹æ³•2ï¼šæ‰‹åŠ¨æŒ‡å®šIP
sudo ./manage-whitelist.sh add 203.0.113.100
```

2. **ä¸´æ—¶ç»™åŒäº‹å¼€æ”¾è®¿é—®**ï¼š
```bash
# æ·»åŠ åŒäº‹çš„IP
sudo ./manage-whitelist.sh add 198.51.100.50

# å®Œæˆååˆ é™¤
sudo ./manage-whitelist.sh remove 198.51.100.50
```

### 3. security-check.sh - å®‰å…¨æ£€æŸ¥è„šæœ¬

**åŠŸèƒ½**ï¼š
- ğŸ” æ£€æŸ¥é˜²ç«å¢™é…ç½®
- ğŸ” æ£€æŸ¥SSHå®‰å…¨è®¾ç½®
- ğŸ” æ£€æŸ¥Fail2BançŠ¶æ€
- ğŸ” æ£€æŸ¥å¼€æ”¾ç«¯å£
- ğŸ” æ£€æŸ¥ç³»ç»Ÿæ›´æ–°
- ğŸ” æ£€æŸ¥ç™»å½•æ—¥å¿—
- ğŸ” æ£€æŸ¥ç£ç›˜ç©ºé—´
- ğŸ” æ£€æŸ¥æœåŠ¡è¿è¡ŒçŠ¶æ€
- ğŸ” æ£€æŸ¥ç½‘ç»œè¿æ¥
- ğŸ” æ£€æŸ¥ç³»ç»Ÿèµ„æº

**ä½¿ç”¨æ–¹æ³•**ï¼š
```bash
sudo ./security-check.sh
```

**å»ºè®®è®¾ç½®å®šæ—¶ä»»åŠ¡**ï¼š
```bash
# ç¼–è¾‘crontab
crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ¯å¤©æ—©ä¸Š8ç‚¹æ‰§è¡Œæ£€æŸ¥ï¼‰
0 8 * * * /home/ubuntu/logistics-ai/scripts/security-check.sh > /var/log/security-check.log 2>&1
```

## ğŸ” å®‰å…¨é…ç½®è¯¦è§£

### ç«¯å£è®¿é—®ç­–ç•¥

| ç«¯å£ | æœåŠ¡ | è®¿é—®ç­–ç•¥ |
|------|------|----------|
| 22 | SSH | ä»…ç™½åå•IP |
| 80 | HTTP | å…¬å¼€è®¿é—® |
| 443 | HTTPS | å…¬å¼€è®¿é—® |
| 9000 | Nginxç®¡ç† | å…¬å¼€è®¿é—® |
| 3000 | å‰ç«¯æœåŠ¡ | ä»…æœ¬åœ° |
| 3001 | å‰ç«¯æœåŠ¡ | ä»…æœ¬åœ° |
| 5432 | PostgreSQL | ä»…æœ¬åœ° |
| 6379 | Redis | ä»…æœ¬åœ° |
| 8000 | åç«¯API | ä»…æœ¬åœ° |
| 33066 | MySQL | ä»…æœ¬åœ° |

### SSHå®‰å…¨è®¾ç½®

- âœ… ç¦ç”¨å¯†ç ç™»å½•ï¼ˆä»…å…è®¸å¯†é’¥ç™»å½•ï¼‰
- âœ… ç¦ç”¨rootç›´æ¥ç™»å½•
- âœ… è®¾ç½®è¿æ¥è¶…æ—¶ï¼ˆ5åˆ†é’Ÿæ— æ“ä½œè‡ªåŠ¨æ–­å¼€ï¼‰
- âœ… é™åˆ¶è¿æ¥å°è¯•ï¼ˆæ¯åˆ†é’Ÿæœ€å¤š3æ¬¡ï¼‰

### Fail2Bané…ç½®

- ğŸš« SSHæš´åŠ›ç ´è§£é˜²æŠ¤ï¼š3æ¬¡å¤±è´¥åå°ç¦1å°æ—¶
- ğŸš« Nginxè®¤è¯å¤±è´¥é˜²æŠ¤
- ğŸš« Nginxè¯·æ±‚é™åˆ¶é˜²æŠ¤

## ğŸ› ï¸ å¸¸è§æ“ä½œ

### åœºæ™¯1ï¼šIPåœ°å€å˜æ›´

å¦‚æœä½ çš„å…¬ç½‘IPå˜æ›´äº†ï¼Œæ— æ³•SSHè¿æ¥ï¼š

**æ–¹æ¡ˆAï¼šä½¿ç”¨è…¾è®¯äº‘æ§åˆ¶å°**
1. ç™»å½•è…¾è®¯äº‘æ§åˆ¶å°
2. è¿›å…¥äº‘æœåŠ¡å™¨ç®¡ç†
3. ä½¿ç”¨VNCç™»å½•
4. è¿è¡Œï¼š`sudo ./manage-whitelist.sh current`

**æ–¹æ¡ˆBï¼šä¸´æ—¶å…³é—­é˜²ç«å¢™**ï¼ˆä¸æ¨èï¼‰
1. é€šè¿‡è…¾è®¯äº‘VNCç™»å½•
2. è¿è¡Œï¼š`sudo iptables -F`ï¼ˆæ¸…ç©ºæ‰€æœ‰è§„åˆ™ï¼‰
3. æ·»åŠ æ–°IPåé‡æ–°åº”ç”¨è§„åˆ™

### åœºæ™¯2ï¼šæŸ¥çœ‹è¢«å°ç¦çš„IP

```bash
# æŸ¥çœ‹Fail2Banå°ç¦åˆ—è¡¨
sudo fail2ban-client status sshd

# è§£å°ç‰¹å®šIP
sudo fail2ban-client set sshd unbanip 192.0.2.100
```

### åœºæ™¯3ï¼šä¸´æ—¶å…è®¸æ‰€æœ‰IPè®¿é—®ï¼ˆç´§æ€¥æƒ…å†µï¼‰

```bash
# ä¸´æ—¶å¼€æ”¾SSHï¼ˆé‡å¯åå¤±æ•ˆï¼‰
sudo iptables -I INPUT -p tcp --dport 22 -j ACCEPT

# å®Œæˆæ“ä½œåï¼Œé‡æ–°åº”ç”¨ç™½åå•
sudo ./manage-whitelist.sh apply
```

### åœºæ™¯4ï¼šå¤‡ä»½å’Œæ¢å¤é˜²ç«å¢™è§„åˆ™

```bash
# å¤‡ä»½å½“å‰è§„åˆ™
sudo iptables-save > /tmp/iptables-backup.txt

# æ¢å¤è§„åˆ™
sudo iptables-restore < /tmp/iptables-backup.txt
```

## ğŸ“Š ç›‘æ§å’Œå‘Šè­¦

### æŸ¥çœ‹å®‰å…¨æ—¥å¿—

```bash
# SSHç™»å½•æ—¥å¿—
sudo tail -f /var/log/auth.log

# Fail2Banæ—¥å¿—
sudo tail -f /var/log/fail2ban.log

# Nginxè®¿é—®æ—¥å¿—
sudo tail -f /var/log/nginx/access.log

# Nginxé”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log
```

### è®¾ç½®é‚®ä»¶å‘Šè­¦

ç¼–è¾‘ `/etc/fail2ban/jail.local`ï¼š

```ini
[DEFAULT]
destemail = your-email@example.com
sendername = Fail2Ban
mta = sendmail
action = %(action_mwl)s
```

## ğŸ”„ å®šæœŸç»´æŠ¤

å»ºè®®æ¯å‘¨æ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š

```bash
# 1. è¿è¡Œå®‰å…¨æ£€æŸ¥
sudo ./security-check.sh

# 2. æŸ¥çœ‹ç³»ç»Ÿæ›´æ–°
sudo apt update
sudo apt list --upgradable

# 3. æŸ¥çœ‹ç£ç›˜ç©ºé—´
df -h

# 4. æŸ¥çœ‹ç³»ç»Ÿè´Ÿè½½
uptime

# 5. æŸ¥çœ‹æœ€è¿‘ç™»å½•
last -n 20

# 6. æŸ¥çœ‹Fail2Banç»Ÿè®¡
sudo fail2ban-client status
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å¤‡ä»½ä¼˜å…ˆ**ï¼šåœ¨æ‰§è¡Œä»»ä½•å®‰å…¨é…ç½®å‰ï¼Œå»ºè®®å…ˆåœ¨è…¾è®¯äº‘æ§åˆ¶å°åˆ›å»ºæœåŠ¡å™¨å¿«ç…§

2. **æµ‹è¯•è¿æ¥**ï¼šé…ç½®é˜²ç«å¢™åï¼Œä¸è¦ç«‹å³å…³é—­å½“å‰SSHä¼šè¯ï¼Œå…ˆå¼€å¯æ–°çš„SSHè¿æ¥æµ‹è¯•

3. **ç™½åå•ç®¡ç†**ï¼šå®šæœŸæ£€æŸ¥ç™½åå•ï¼Œåˆ é™¤ä¸å†éœ€è¦çš„IP

4. **æ—¥å¿—ç›‘æ§**ï¼šå®šæœŸæŸ¥çœ‹å®‰å…¨æ—¥å¿—ï¼ŒåŠæ—¶å‘ç°å¼‚å¸¸

5. **ç³»ç»Ÿæ›´æ–°**ï¼šå®šæœŸæ›´æ–°ç³»ç»Ÿå’Œè½¯ä»¶åŒ…ï¼Œä¿®å¤å®‰å…¨æ¼æ´

6. **å¯†é’¥å®‰å…¨**ï¼šå¦¥å–„ä¿ç®¡SSHç§é’¥æ–‡ä»¶ï¼ˆCursor.pemï¼‰ï¼Œä¸è¦æ³„éœ²

## ğŸ†˜ ç´§æ€¥æƒ…å†µå¤„ç†

### å¦‚æœè¢«é”åœ¨æœåŠ¡å™¨å¤–

1. ç™»å½•è…¾è®¯äº‘æ§åˆ¶å°
2. ä½¿ç”¨VNCç™»å½•æœåŠ¡å™¨
3. è¿è¡Œä»¥ä¸‹å‘½ä»¤ä¸´æ—¶å¼€æ”¾SSHï¼š
```bash
sudo iptables -I INPUT -p tcp --dport 22 -j ACCEPT
```
4. ä»ä½ çš„æ–°IPè¿æ¥åï¼Œæ·»åŠ æ–°IPåˆ°ç™½åå•
5. é‡æ–°åº”ç”¨å®‰å…¨è§„åˆ™

### å¦‚æœæœåŠ¡å™¨è¢«æ”»å‡»

1. ç«‹å³æŸ¥çœ‹æ´»è·ƒè¿æ¥ï¼š
```bash
sudo netstat -tn | grep ESTABLISHED
```

2. å°ç¦å¯ç–‘IPï¼š
```bash
sudo iptables -I INPUT -s å¯ç–‘IP -j DROP
```

3. æŸ¥çœ‹ç³»ç»Ÿè¿›ç¨‹ï¼š
```bash
top
ps aux | grep suspicious
```

4. æŸ¥çœ‹ç™»å½•è®°å½•ï¼š
```bash
last -n 50
sudo grep "Failed password" /var/log/auth.log
```

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜ã€‚

---

**æœ€åæ›´æ–°**: 2026-01-19
**ç»´æŠ¤è€…**: ç³»ç»Ÿç®¡ç†å‘˜
