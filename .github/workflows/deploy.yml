# Áâ©ÊµÅËé∑ÂÆ¢AI - Ëá™Âä®ÈÉ®ÁΩ≤Âà∞ËÖæËÆØ‰∫ë CVM
# Ëß¶ÂèëÊù°‰ª∂: Êé®ÈÄÅÂà∞ main ÂàÜÊîØ Êàñ ÊâãÂä®Ëß¶Âèë

name: üöÄ ÈÉ®ÁΩ≤Âà∞ËÖæËÆØ‰∫ë

on:
  push:
    branches:
      - main
  workflow_dispatch:  # ÊîØÊåÅÊâãÂä®Ëß¶Âèë
    inputs:
      environment:
        description: 'ÈÉ®ÁΩ≤ÁéØÂ¢É'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  PROJECT_NAME: logistics-ai
  DEPLOY_PATH: /home/ubuntu/logistics-ai

jobs:
  # ==================== ‰ª£Á†ÅÊ£ÄÊü• ====================
  lint-and-test:
    name: üìã ‰ª£Á†ÅÊ£ÄÊü•
    runs-on: ubuntu-latest
    steps:
      - name: üì• ÊãâÂèñ‰ª£Á†Å
        uses: actions/checkout@v4

      - name: üêç ËÆæÁΩÆ Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üì¶ ÂÆâË£ÖÂêéÁ´Ø‰æùËµñ
        run: |
          cd backend
          pip install -r requirements.txt

      - name: üîç Python ËØ≠Ê≥ïÊ£ÄÊü•
        run: |
          pip install flake8
          cd backend
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true

      - name: üì¶ ËÆæÁΩÆ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package.json

      - name: üì¶ ÂÆâË£ÖÂâçÁ´Ø‰æùËµñ
        run: |
          cd frontend
          npm ci --legacy-peer-deps || npm install

      - name: üîç TypeScript Á±ªÂûãÊ£ÄÊü•
        run: |
          cd frontend
          npm run build || echo "Build check completed"

  # ==================== ÈÉ®ÁΩ≤Âà∞ÊúçÂä°Âô® ====================
  deploy:
    name: üöÄ ÈÉ®ÁΩ≤Âà∞ÊúçÂä°Âô®
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: üì• ÊãâÂèñ‰ª£Á†Å
        uses: actions/checkout@v4

      - name: üîê ÈÖçÁΩÆ SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: üìù Ê∑ªÂä†ÊúçÂä°Âô®Âà∞Â∑≤Áü•‰∏ªÊú∫
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: üöÄ ÈÉ®ÁΩ≤Âà∞ÊúçÂä°Âô®
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
          # Êï∞ÊçÆÂ∫ìÈÖçÁΩÆ
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          # AI API ÈÖçÁΩÆ
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          KELING_API_KEY: ${{ secrets.KELING_API_KEY }}
          # ‰ºÅ‰∏öÂæÆ‰ø°ÈÖçÁΩÆ
          WECHAT_CORP_ID: ${{ secrets.WECHAT_CORP_ID }}
          WECHAT_AGENT_ID: ${{ secrets.WECHAT_AGENT_ID }}
          WECHAT_SECRET: ${{ secrets.WECHAT_SECRET }}
          # ËÖæËÆØ‰∫ë COS ÈÖçÁΩÆ
          COS_SECRET_ID: ${{ secrets.COS_SECRET_ID }}
          COS_SECRET_KEY: ${{ secrets.COS_SECRET_KEY }}
          COS_BUCKET: ${{ secrets.COS_BUCKET }}
          COS_REGION: ${{ secrets.COS_REGION }}
          # JWT ÈÖçÁΩÆ
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            set -e
            
            echo "üìÇ ËøõÂÖ•ÈÉ®ÁΩ≤ÁõÆÂΩï..."
            mkdir -p ${{ env.DEPLOY_PATH }}
            cd ${{ env.DEPLOY_PATH }}
            
            echo "üì• ÊãâÂèñÊúÄÊñ∞‰ª£Á†Å..."
            if [ -d ".git" ]; then
              echo "‚úÖ Git ‰ªìÂ∫ìÂ∑≤Â≠òÂú®ÔºåÊõ¥Êñ∞‰ª£Á†Å..."
              git fetch origin main || { echo "‚ùå Git fetch Â§±Ë¥•"; exit 1; }
              git reset --hard origin/main || { echo "‚ùå Git reset Â§±Ë¥•"; exit 1; }
            else
              echo "üì¶ È¶ñÊ¨°ÈÉ®ÁΩ≤ÔºåÂÖãÈöÜ‰ªìÂ∫ì..."
              rm -rf * .* 2>/dev/null || true
              git clone https://github.com/${{ github.repository }}.git . || { echo "‚ùå Git clone Â§±Ë¥•"; exit 1; }
            fi
            
            echo "‚úÖ È™åËØÅ‰ª£Á†ÅÊãâÂèñÊàêÂäü..."
            if [ ! -f "docker-compose.prod.yml" ]; then
              echo "‚ùå ÈîôËØØ: docker-compose.prod.yml Êñá‰ª∂‰∏çÂ≠òÂú®!"
              ls -la
              exit 1
            fi
            echo "‚úÖ docker-compose.prod.yml Êñá‰ª∂Â≠òÂú®"
            
            echo "üìù ÂàõÂª∫ÁéØÂ¢ÉÂèòÈáèÊñá‰ª∂..."
            cat > .env << EOF
          # Êï∞ÊçÆÂ∫ìÈÖçÁΩÆ
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          
          # AI API ÈÖçÁΩÆ
          DASHSCOPE_API_KEY=${{ secrets.DASHSCOPE_API_KEY }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          KELING_API_KEY=${{ secrets.KELING_API_KEY }}
          
          # ‰ºÅ‰∏öÂæÆ‰ø°ÈÖçÁΩÆ
          WECHAT_CORP_ID=${{ secrets.WECHAT_CORP_ID }}
          WECHAT_AGENT_ID=${{ secrets.WECHAT_AGENT_ID }}
          WECHAT_SECRET=${{ secrets.WECHAT_SECRET }}
          
          # ËÖæËÆØ‰∫ë COS ÈÖçÁΩÆ
          COS_SECRET_ID=${{ secrets.COS_SECRET_ID }}
          COS_SECRET_KEY=${{ secrets.COS_SECRET_KEY }}
          COS_BUCKET=${{ secrets.COS_BUCKET }}
          COS_REGION=${{ secrets.COS_REGION }}
          
          # JWT ÈÖçÁΩÆ
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          EOF
            
            echo "üê≥ ‰ΩøÁî® Docker Compose ÈÉ®ÁΩ≤..."
            docker compose -f docker-compose.prod.yml down || true
            docker compose -f docker-compose.prod.yml pull || true
            docker compose -f docker-compose.prod.yml up -d --build || { echo "‚ùå Docker Compose ÂêØÂä®Â§±Ë¥•"; exit 1; }
            
            echo "üßπ Ê∏ÖÁêÜÊú™‰ΩøÁî®ÁöÑÈïúÂÉè..."
            docker image prune -f || true
            
            echo "‚úÖ ÈÉ®ÁΩ≤ÂÆåÊàê!"
            docker compose -f docker-compose.prod.yml ps
          ENDSSH

      - name: üìä ÂÅ•Â∫∑Ê£ÄÊü•
        run: |
          echo "‚è≥ Á≠âÂæÖÊúçÂä°ÂêØÂä®..."
          sleep 30
          echo "üîç Ê£ÄÊü•ÊúçÂä°Áä∂ÊÄÅ..."
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "cd ${{ env.DEPLOY_PATH }} && docker compose -f docker-compose.prod.yml ps"

  # ==================== ÈÉ®ÁΩ≤ÈÄöÁü• ====================
  notify:
    name: üì¢ ÈÉ®ÁΩ≤ÈÄöÁü•
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: üì¢ ÂèëÈÄÅÈÉ®ÁΩ≤ÁªìÊûúÈÄöÁü•
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ ÈÉ®ÁΩ≤ÊàêÂäü!"
            echo "üîó ËÆøÈóÆÂú∞ÂùÄ: http://${{ secrets.SERVER_HOST }}"
          else
            echo "‚ùå ÈÉ®ÁΩ≤Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êó•Âøó"
          fi
