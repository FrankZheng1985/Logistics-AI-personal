# ç‰©æµè·å®¢AI - è‡ªåŠ¨éƒ¨ç½²åˆ°è…¾è®¯äº‘ CVM
# è§¦å‘æ¡ä»¶: æ¨é€åˆ° main åˆ†æ”¯ æˆ– æ‰‹åŠ¨è§¦å‘

name: ğŸš€ éƒ¨ç½²åˆ°è…¾è®¯äº‘

on:
  push:
    branches:
      - main
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  PROJECT_NAME: logistics-ai
  DEPLOY_PATH: /home/ubuntu/logistics-ai

jobs:
  # ==================== ä»£ç æ£€æŸ¥ ====================
  lint-and-test:
    name: ğŸ“‹ ä»£ç æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£…åç«¯ä¾èµ–
        run: |
          cd backend
          pip install -r requirements.txt

      - name: ğŸ” Python è¯­æ³•æ£€æŸ¥
        run: |
          pip install flake8
          cd backend
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package.json

      - name: ğŸ“¦ å®‰è£…å‰ç«¯ä¾èµ–
        run: |
          cd frontend
          npm ci --legacy-peer-deps || npm install

      - name: ğŸ” TypeScript ç±»å‹æ£€æŸ¥
        run: |
          cd frontend
          npm run build || echo "Build check completed"

  # ==================== éƒ¨ç½²åˆ°æœåŠ¡å™¨ ====================
  deploy:
    name: ğŸš€ éƒ¨ç½²åˆ°æœåŠ¡å™¨
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ” è°ƒè¯• - æ£€æŸ¥ Secrets æ˜¯å¦å­˜åœ¨
        run: |
          echo "æ£€æŸ¥ SERVER_HOST..."
          if [ -z "${{ secrets.SERVER_HOST }}" ]; then
            echo "âŒ SERVER_HOST æœªè®¾ç½®!"
            exit 1
          else
            echo "âœ… SERVER_HOST å·²è®¾ç½®"
          fi
          echo "æ£€æŸ¥ SERVER_USER..."
          if [ -z "${{ secrets.SERVER_USER }}" ]; then
            echo "âŒ SERVER_USER æœªè®¾ç½®!"
            exit 1
          else
            echo "âœ… SERVER_USER å·²è®¾ç½®"
          fi
          echo "æ£€æŸ¥ SERVER_SSH_KEY..."
          if [ -z "${{ secrets.SERVER_SSH_KEY }}" ]; then
            echo "âŒ SERVER_SSH_KEY æœªè®¾ç½®!"
            exit 1
          else
            echo "âœ… SERVER_SSH_KEY å·²è®¾ç½® (é•¿åº¦: ${#SSH_KEY} å­—ç¬¦)"
          fi
        env:
          SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}

      - name: ğŸ” é…ç½® SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      - name: ğŸ“ æ·»åŠ æœåŠ¡å™¨åˆ°å·²çŸ¥ä¸»æœº
        run: |
          mkdir -p ~/.ssh
          echo "æ­£åœ¨æ‰«ææœåŠ¡å™¨ ${{ secrets.SERVER_HOST }}..."
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          echo "âœ… å·²æ·»åŠ åˆ° known_hosts"

      - name: ğŸ“¦ æ‰“åŒ…ä»£ç 
        run: |
          echo "ğŸ“¦ æ‰“åŒ…ä»£ç ..."
          # ä½¿ç”¨ --warning=no-file-changed å¿½ç•¥æ–‡ä»¶å˜åŒ–è­¦å‘Š
          tar -czf deploy.tar.gz \
            --warning=no-file-changed \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.env' \
            --exclude='deploy.tar.gz' \
            . || [[ $? -eq 1 ]]
          echo "âœ… æ‰“åŒ…å®Œæˆ"

      - name: ğŸ“¤ ä¸Šä¼ ä»£ç åˆ°æœåŠ¡å™¨
        run: |
          echo "ğŸ“¤ ä¸Šä¼ ä»£ç åˆ°æœåŠ¡å™¨..."
          ls -lh deploy.tar.gz
          scp -v deploy.tar.gz ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/deploy.tar.gz || { echo "âŒ scp ä¸Šä¼ å¤±è´¥"; exit 1; }
          echo "âœ… ä»£ç ä¸Šä¼ æˆåŠŸ"
          
      - name: ğŸ“¥ åœ¨æœåŠ¡å™¨ä¸Šè§£å‹ä»£ç 
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            set -e
            echo "ğŸ“‚ è¿›å…¥éƒ¨ç½²ç›®å½•..."
            mkdir -p ${{ env.DEPLOY_PATH }}
            cd ${{ env.DEPLOY_PATH }}
            echo "âœ… éªŒè¯ deploy.tar.gz å­˜åœ¨..."
            if [ ! -f "deploy.tar.gz" ]; then
              echo "âŒ é”™è¯¯: deploy.tar.gz æ–‡ä»¶ä¸å­˜åœ¨!"
              ls -la
              exit 1
            fi
            echo "ğŸ“¦ è§£å‹ä»£ç ..."
            tar -xzf deploy.tar.gz || { echo "âŒ tar è§£å‹å¤±è´¥"; exit 1; }
            rm -f deploy.tar.gz
            echo "âœ… éªŒè¯ docker-compose.prod.yml å­˜åœ¨..."
            if [ ! -f "docker-compose.prod.yml" ]; then
              echo "âŒ é”™è¯¯: docker-compose.prod.yml æ–‡ä»¶ä¸å­˜åœ¨!"
              ls -la
              exit 1
            fi
            echo "âœ… ä»£ç è§£å‹å®Œæˆ"
          ENDSSH

      - name: ğŸš€ éƒ¨ç½²åˆ°æœåŠ¡å™¨
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
          # æ•°æ®åº“é…ç½®
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          # AI API é…ç½®
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          KELING_API_KEY: ${{ secrets.KELING_API_KEY }}
          # ä¼ä¸šå¾®ä¿¡é…ç½®
          WECHAT_CORP_ID: ${{ secrets.WECHAT_CORP_ID }}
          WECHAT_AGENT_ID: ${{ secrets.WECHAT_AGENT_ID }}
          WECHAT_SECRET: ${{ secrets.WECHAT_SECRET }}
          # è…¾è®¯äº‘ COS é…ç½®
          COS_SECRET_ID: ${{ secrets.COS_SECRET_ID }}
          COS_SECRET_KEY: ${{ secrets.COS_SECRET_KEY }}
          COS_BUCKET: ${{ secrets.COS_BUCKET }}
          COS_REGION: ${{ secrets.COS_REGION }}
          # JWT é…ç½®
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            set -e
            
            echo "ğŸ“‚ è¿›å…¥éƒ¨ç½²ç›®å½•..."
            mkdir -p ${{ env.DEPLOY_PATH }}
            cd ${{ env.DEPLOY_PATH }}
            
            echo "âœ… éªŒè¯æ–‡ä»¶å­˜åœ¨..."
            if [ ! -f "docker-compose.prod.yml" ]; then
              echo "âŒ é”™è¯¯: docker-compose.prod.yml æ–‡ä»¶ä¸å­˜åœ¨!"
              ls -la
              exit 1
            fi
            echo "âœ… docker-compose.prod.yml æ–‡ä»¶å­˜åœ¨"
            
            echo "ğŸ“ åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶..."
            cat > .env << EOF
          # æ•°æ®åº“é…ç½®
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          
          # AI API é…ç½®
          DASHSCOPE_API_KEY=${{ secrets.DASHSCOPE_API_KEY }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          KELING_API_KEY=${{ secrets.KELING_API_KEY }}
          
          # ä¼ä¸šå¾®ä¿¡é…ç½®
          WECHAT_CORP_ID=${{ secrets.WECHAT_CORP_ID }}
          WECHAT_AGENT_ID=${{ secrets.WECHAT_AGENT_ID }}
          WECHAT_SECRET=${{ secrets.WECHAT_SECRET }}
          
          # è…¾è®¯äº‘ COS é…ç½®
          COS_SECRET_ID=${{ secrets.COS_SECRET_ID }}
          COS_SECRET_KEY=${{ secrets.COS_SECRET_KEY }}
          COS_BUCKET=${{ secrets.COS_BUCKET }}
          COS_REGION=${{ secrets.COS_REGION }}
          
          # JWT é…ç½®
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          EOF
            
            echo "ğŸ³ ä½¿ç”¨ Docker Compose éƒ¨ç½²..."
            docker compose -f docker-compose.prod.yml down || true
            docker compose -f docker-compose.prod.yml pull || true
            
            echo "ğŸ“¦ å¯åŠ¨æ•°æ®åº“å’Œ Redis..."
            docker compose -f docker-compose.prod.yml up -d postgres redis || { echo "âŒ æ•°æ®åº“å¯åŠ¨å¤±è´¥"; exit 1; }
            
            echo "â³ ç­‰å¾…æ•°æ®åº“å°±ç»ª..."
            sleep 10
            
            echo "ğŸ” æ£€æŸ¥æ•°æ®åº“å¥åº·çŠ¶æ€..."
            for i in {1..30}; do
              if docker compose -f docker-compose.prod.yml exec -T postgres pg_isready -U ${{ secrets.POSTGRES_USER }} -d ${{ secrets.POSTGRES_DB }} > /dev/null 2>&1; then
                echo "âœ… æ•°æ®åº“å·²å°±ç»ª"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "âŒ æ•°æ®åº“å¯åŠ¨è¶…æ—¶"
                docker compose -f docker-compose.prod.yml logs postgres
                exit 1
              fi
              echo "â³ ç­‰å¾…æ•°æ®åº“å¯åŠ¨... ($i/30)"
              sleep 2
            done
            
            echo "ğŸ” éªŒè¯æ•°æ®åº“åˆå§‹åŒ–..."
            TABLE_COUNT=$(docker compose -f docker-compose.prod.yml exec -T postgres psql -U ${{ secrets.POSTGRES_USER }} -d ${{ secrets.POSTGRES_DB }} -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';" 2>/dev/null | tr -d ' ' || echo "0")
            if [ "$TABLE_COUNT" -gt "0" ]; then
              echo "âœ… æ•°æ®åº“è¡¨å·²åˆ›å»º ($TABLE_COUNT ä¸ªè¡¨)"
            else
              echo "âš ï¸  æ•°æ®åº“è¡¨æœªåˆ›å»ºï¼Œå°†è‡ªåŠ¨åˆå§‹åŒ–..."
            fi
            
            echo "ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡..."
            docker compose -f docker-compose.prod.yml up -d --build || { echo "âŒ Docker Compose å¯åŠ¨å¤±è´¥"; exit 1; }
            
            echo "ğŸ§¹ æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ..."
            docker image prune -f || true
            
            echo "âœ… éƒ¨ç½²å®Œæˆ!"
            docker compose -f docker-compose.prod.yml ps
          ENDSSH

      - name: ğŸ“Š å¥åº·æ£€æŸ¥
        run: |
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 30
          echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}
            
            echo "ğŸ“Š Docker Compose æœåŠ¡çŠ¶æ€:"
            docker compose -f docker-compose.prod.yml ps
            
            echo ""
            echo "ğŸ” æ•°æ®åº“å¥åº·æ£€æŸ¥..."
            if docker compose -f docker-compose.prod.yml exec -T postgres pg_isready -U ${{ secrets.POSTGRES_USER }} -d ${{ secrets.POSTGRES_DB }} > /dev/null 2>&1; then
              echo "âœ… PostgreSQL æ•°æ®åº“è¿æ¥æ­£å¸¸"
              
              echo "ğŸ“Š æ•°æ®åº“è¡¨ç»Ÿè®¡:"
              TABLE_COUNT=$(docker compose -f docker-compose.prod.yml exec -T postgres psql -U ${{ secrets.POSTGRES_USER }} -d ${{ secrets.POSTGRES_DB }} -t -c "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';" 2>/dev/null | tr -d ' ')
              echo "   è¡¨æ•°é‡: $TABLE_COUNT"
              
              echo "ğŸ“Š AIå‘˜å·¥æ•°é‡:"
              AGENT_COUNT=$(docker compose -f docker-compose.prod.yml exec -T postgres psql -U ${{ secrets.POSTGRES_USER }} -d ${{ secrets.POSTGRES_DB }} -t -c "SELECT COUNT(*) FROM ai_agents;" 2>/dev/null | tr -d ' ')
              echo "   AIå‘˜å·¥: $AGENT_COUNT"
            else
              echo "âŒ PostgreSQL æ•°æ®åº“è¿æ¥å¤±è´¥"
              exit 1
            fi
            
            echo ""
            echo "ğŸ” Redis å¥åº·æ£€æŸ¥..."
            if docker compose -f docker-compose.prod.yml exec -T redis redis-cli ping > /dev/null 2>&1; then
              echo "âœ… Redis è¿æ¥æ­£å¸¸"
            else
              echo "âŒ Redis è¿æ¥å¤±è´¥"
              exit 1
            fi
            
            echo ""
            echo "ğŸ” åç«¯æœåŠ¡å¥åº·æ£€æŸ¥..."
            if curl -f http://localhost:8000/health > /dev/null 2>&1; then
              echo "âœ… åç«¯æœåŠ¡æ­£å¸¸"
            else
              echo "âš ï¸  åç«¯æœåŠ¡å¯èƒ½è¿˜åœ¨å¯åŠ¨ä¸­..."
            fi
            
            echo ""
            echo "âœ… æ‰€æœ‰å¥åº·æ£€æŸ¥å®Œæˆ!"
          ENDSSH

  # ==================== éƒ¨ç½²é€šçŸ¥ ====================
  notify:
    name: ğŸ“¢ éƒ¨ç½²é€šçŸ¥
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: ğŸ“¢ å‘é€éƒ¨ç½²ç»“æœé€šçŸ¥
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸ!"
            echo "ğŸ”— è®¿é—®åœ°å€: http://${{ secrets.SERVER_HOST }}"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi
