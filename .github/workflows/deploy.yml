# ç‰©æµè·å®¢AI - è‡ªåŠ¨éƒ¨ç½²å·¥ä½œæµï¼ˆåŸç”Ÿéƒ¨ç½²ç‰ˆæœ¬ï¼‰
# å½“ä»£ç æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨éƒ¨ç½²åˆ°è…¾è®¯äº‘æœåŠ¡å™¨
# ä¸ä½¿ç”¨ Dockerï¼Œç›´æ¥éƒ¨ç½²åˆ°ç³»ç»ŸæœåŠ¡

name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          command_timeout: 15m
          script: |
            set -e
            
            # è®¾ç½® Node.js ç¯å¢ƒå˜é‡ï¼ˆç¡®ä¿ npm/pm2 å‘½ä»¤å¯ç”¨ï¼‰
            export PATH="/opt/nodejs/bin:$PATH"
            
            cd /home/ubuntu/logistics-ai
            
            echo "=============================================="
            echo "    å¼€å§‹éƒ¨ç½² - åŸç”Ÿéƒ¨ç½²æ–¹å¼"
            echo "=============================================="
            
            # é…ç½® GitHub é•œåƒä»£ç†ï¼ˆè§£å†³å›½å†…æœåŠ¡å™¨è®¿é—® GitHub æ…¢çš„é—®é¢˜ï¼‰
            echo "ğŸŒ é…ç½® GitHub é•œåƒä»£ç†..."
            git config --global url.'https://gitclone.com/github.com/'.insteadOf 'https://github.com/' 2>/dev/null || true
            
            # æ‹‰å–æœ€æ–°ä»£ç ï¼ˆå¸¦é‡è¯•ï¼‰
            echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
            for i in 1 2 3; do
              git pull origin main && break
              echo "âš ï¸ ç¬¬ $i æ¬¡æ‹‰å–å¤±è´¥ï¼Œé‡è¯•ä¸­..."
              sleep 5
            done
            
            # æ£€æŸ¥å“ªäº›æ–‡ä»¶æœ‰å˜åŒ–
            BACKEND_CHANGED=$(git diff HEAD~1 --name-only | grep -E '^backend/' | wc -l || echo 0)
            FRONTEND_CHANGED=$(git diff HEAD~1 --name-only | grep -E '^frontend/' | wc -l || echo 0)
            DATABASE_CHANGED=$(git diff HEAD~1 --name-only | grep -E '^database/' | wc -l || echo 0)
            
            echo "ğŸ“Š å˜æ›´æ£€æµ‹: Backend=$BACKEND_CHANGED, Frontend=$FRONTEND_CHANGED, Database=$DATABASE_CHANGED"
            
            # =================================================================
            # æ•°æ®åº“è¿ç§»ï¼ˆå¦‚æœæœ‰å˜åŒ–ï¼‰
            # =================================================================
            if [ "$DATABASE_CHANGED" -gt 0 ]; then
              echo "ğŸ—„ï¸ æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
              source .env 2>/dev/null || true
              DB_USER="${POSTGRES_USER:-admin}"
              DB_NAME="${POSTGRES_DB:-logistics_ai}"
              
              for migration in database/migrations/*.sql; do
                if [ -f "$migration" ]; then
                  echo "  æ‰§è¡Œ: $(basename $migration)"
                  sudo -u postgres psql -d "$DB_NAME" -f "$migration" 2>/dev/null || true
                fi
              done
            fi
            
            # =================================================================
            # åç«¯æ›´æ–°
            # =================================================================
            if [ "$BACKEND_CHANGED" -gt 0 ]; then
              echo "ğŸ”§ æ›´æ–°åç«¯..."
              
              cd backend
              
              # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
              source venv/bin/activate
              
              # æ›´æ–°ä¾èµ–ï¼ˆå¦‚æœ requirements.txt æœ‰å˜åŒ–ï¼‰
              if git diff HEAD~1 --name-only | grep -q 'backend/requirements.txt'; then
                echo "  ğŸ“¦ å®‰è£…æ–°ä¾èµ–..."
                pip install -r requirements.txt -q
              fi
              
              deactivate
              cd ..
              
              # é‡å¯åç«¯æœåŠ¡
              echo "  ğŸ”„ é‡å¯åç«¯æœåŠ¡..."
              sudo systemctl restart logistics-backend
              sleep 5
              
              # æ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨æˆåŠŸ
              if curl -sf http://127.0.0.1:8000/health > /dev/null 2>&1; then
                echo "  âœ… åç«¯é‡å¯æˆåŠŸ"
              else
                echo "  âš ï¸ åç«¯å¯åŠ¨ä¸­ï¼Œç­‰å¾…..."
                sleep 10
              fi
            fi
            
            # =================================================================
            # å‰ç«¯æ›´æ–°
            # =================================================================
            if [ "$FRONTEND_CHANGED" -gt 0 ]; then
              echo "ğŸ¨ æ›´æ–°å‰ç«¯..."
              
              cd frontend
              
              # æ›´æ–°ä¾èµ–ï¼ˆå¦‚æœ package.json æœ‰å˜åŒ–ï¼‰
              if git diff HEAD~1 --name-only | grep -q 'frontend/package.json'; then
                echo "  ğŸ“¦ å®‰è£…æ–°ä¾èµ–..."
                npm ci --legacy-peer-deps
              fi
              
              # é‡æ–°æ„å»º
              echo "  ğŸ”¨ é‡æ–°æ„å»º..."
              npm run build
              
              cd ..
              
              # é‡å¯å‰ç«¯æœåŠ¡
              echo "  ğŸ”„ é‡å¯å‰ç«¯æœåŠ¡..."
              cd frontend
              pm2 reload ecosystem.config.js 2>/dev/null || pm2 start ecosystem.config.js
              cd ..
              
              sleep 3
              
              if curl -sf http://127.0.0.1:3000 > /dev/null 2>&1; then
                echo "  âœ… å‰ç«¯é‡å¯æˆåŠŸ"
              else
                echo "  âš ï¸ å‰ç«¯å¯åŠ¨ä¸­..."
              fi
            fi
            
            # =================================================================
            # æ— å˜åŒ–æ—¶çš„ç®€å•é‡å¯ï¼ˆå¯é€‰ï¼‰
            # =================================================================
            if [ "$BACKEND_CHANGED" -eq 0 ] && [ "$FRONTEND_CHANGED" -eq 0 ]; then
              echo "â­ï¸ ä»£ç æ— å˜åŒ–ï¼Œè·³è¿‡é‡å¯"
            fi
            
            # =================================================================
            # æœ€ç»ˆå¥åº·æ£€æŸ¥
            # =================================================================
            echo ""
            echo "ğŸ¥ æœ€ç»ˆå¥åº·æ£€æŸ¥..."
            echo "-------------------------------------------"
            
            # PostgreSQL
            if sudo systemctl is-active --quiet postgresql; then
              echo "âœ… PostgreSQL: è¿è¡Œä¸­"
            else
              echo "âŒ PostgreSQL: å·²åœæ­¢"
            fi
            
            # Redis
            if sudo systemctl is-active --quiet redis-server; then
              echo "âœ… Redis: è¿è¡Œä¸­"
            else
              echo "âŒ Redis: å·²åœæ­¢"
            fi
            
            # åç«¯
            if curl -sf http://127.0.0.1:8000/health > /dev/null 2>&1; then
              echo "âœ… åç«¯: è¿è¡Œä¸­"
            else
              echo "âš ï¸ åç«¯: å¯åŠ¨ä¸­æˆ–å¼‚å¸¸"
            fi
            
            # å‰ç«¯
            if curl -sf http://127.0.0.1:3000 > /dev/null 2>&1; then
              echo "âœ… å‰ç«¯: è¿è¡Œä¸­"
            else
              echo "âš ï¸ å‰ç«¯: å¯åŠ¨ä¸­æˆ–å¼‚å¸¸"
            fi
            
            # Nginx
            if sudo systemctl is-active --quiet nginx; then
              echo "âœ… Nginx: è¿è¡Œä¸­"
            else
              echo "âŒ Nginx: å·²åœæ­¢"
            fi
            
            echo ""
            echo "=============================================="
            echo "    âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "=============================================="
